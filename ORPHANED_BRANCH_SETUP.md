# Orphaned Branch Setup Guide

**As of v0.7.0, all workflow templates use the orphaned branch pattern by default.**

This guide explains how to set up the orphaned `status-data` branch for storing monitoring data, following best practices used by Upptime and other monitoring tools.

> **Note**: If you're migrating from an older version where data was stored on the main branch, see the "For Existing Projects" section below.

## Why Use an Orphaned Branch?

An orphaned branch provides several benefits for status monitoring data:

### 1. **Repository Size Management**
- Main branch stays lean (faster clones and checkouts)
- Status data history isolated from code history
- Can prune old monitoring data without affecting code

### 2. **Logical Separation of Concerns**
```
main branch:          Source code, documentation, config
status-data branch:   Runtime monitoring data, metrics, incidents
gh-pages branch:      Built static site (if using GitHub Pages)
```

### 3. **Performance Optimization**
Without orphaned branch:
- 288 commits/day √ó 365 = 105,120 commits/year just for status updates
- Pollutes git history with automated commits
- Slows down clone and checkout operations

With orphaned branch:
- Main branch remains clean with only code commits
- Status updates isolated to separate branch
- Fast operations on main branch

### 4. **CI/CD Isolation**
- Status updates don't trigger unnecessary CI/CD pipelines
- Clear separation in workflow triggers
- Easier to manage retention policies

## Quick Start

### For New Projects (No Existing Data)

```bash
# Run the setup script with npx
npx stentorosaur-setup-status-branch

# Or if running from plugin development directory
npm run setup-status-branch
```

This creates an orphaned `status-data` branch with the proper structure.

### For Existing Projects (With Status Data)

```bash
# Step 1: Create the orphaned branch
npx stentorosaur-setup-status-branch

# Step 2: Migrate existing data
npx stentorosaur-migrate-to-status-branch

# Optional: Keep data on main branch (not recommended)
npx stentorosaur-migrate-to-status-branch --keep-on-main

# Optional: Dry-run to see what would happen
npx stentorosaur-migrate-to-status-branch --dry-run
```

## Manual Setup Instructions

If you prefer to set up manually:

```bash
# 1. Create orphaned branch
git checkout --orphan status-data
git rm -rf .

# 2. Create initial structure
mkdir -p archives
cat > README.md <<'EOF'
# Status Data Branch

This orphaned branch stores runtime monitoring data generated by
@amiable-dev/docusaurus-plugin-stentorosaur.

**Do not merge this branch into main.**
EOF

# 3. Commit initial structure
git add README.md archives/
git commit -m "Initialize status-data orphaned branch"
git push -u origin status-data

# 4. Return to main branch
git checkout main
```

## Updating Workflows

**As of v0.7.0, all workflow templates use the orphaned branch pattern by default.**

If you're setting up a new project or updating from templates, simply copy the workflows from the plugin:

```bash
# Copy all workflow templates
cp node_modules/@amiable-dev/docusaurus-plugin-stentorosaur/templates/workflows/*.yml \
   .github/workflows/
```

The following workflows are already configured for orphaned branch:
- `monitor-systems.yml` - Monitors systems and writes to status-data branch
- `status-update.yml` - Updates incidents/maintenance from GitHub issues
- `deploy.yml` - Builds and deploys, reading from status-data branch
- `deploy-scheduled.yml` - Scheduled deployments
- `compress-archives.yml` - Compresses old JSONL files

### Migrating Existing Workflows

If you have existing workflows from v0.6.x or earlier, update them to use the orphaned branch pattern:

```yaml
name: Monitor Systems

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  issues: write
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      # Checkout main branch for scripts and config
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      # Checkout status-data branch for data storage
      - name: Checkout status-data branch
        uses: actions/checkout@v4
        with:
          ref: status-data
          path: status-data
          fetch-depth: 1  # Shallow clone for speed

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: main
        run: npm ci --production

      - name: Monitor systems
        working-directory: main
        run: |
          npx stentorosaur-monitor \
            --config .monitorrc.json \
            --output-dir ../status-data \
            --verbose

      - name: Commit status data
        working-directory: status-data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "üìä Status update: $(date -u +%Y-%m-%dT%H:%M:%SZ)" || echo "No changes"
          git push origin status-data
```

## Updating Docusaurus Build

Your Docusaurus build needs access to the status-data branch. Update your deployment workflow:

```yaml
name: Deploy to GitHub Pages

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Checkout main for site code
      - uses: actions/checkout@v4
        with:
          path: main

      # Checkout status-data for monitoring data
      - uses: actions/checkout@v4
        with:
          ref: status-data
          path: status-data
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        working-directory: main
        run: npm ci

      - name: Build site
        working-directory: main
        run: |
          # Copy status data to expected location
          cp -r ../status-data ./status-data
          npm run build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./main/build
```

## Plugin Configuration

The plugin works seamlessly with the orphaned branch. No configuration changes needed!

The key is ensuring your build process has access to the `status-data/` directory, which you achieve by either:

1. **Build-time**: Checkout both branches in CI/CD (recommended)
2. **Client-side**: Fetch data via raw GitHub URLs

### Client-Side Fetching (Optional)

If you want to fetch data directly from the orphaned branch on the client:

```typescript
// src/theme/StatusPage/index.tsx
useEffect(() => {
  async function loadStatusData() {
    const response = await fetch(
      'https://raw.githubusercontent.com/YOUR-ORG/YOUR-REPO/status-data/current.json'
    );
    const data = await response.json();
    setStatusData(data);
  }
  loadStatusData();
}, []);
```

## Verifying the Setup

After migration, verify everything works:

```bash
# 1. Check branches exist
git branch -a
# Should show both main and status-data

# 2. Verify orphaned branch has no shared history
git checkout status-data
git log --oneline
# Should show only status-data commits

# 3. Check merge base (should fail)
git merge-base main status-data
# Should fail - no common ancestor

# 4. Verify main is clean
git checkout main
git log --oneline --since="1 day ago"
# Should not show status update commits

# 5. Test setup script
npx stentorosaur-setup-status-branch --force
git checkout status-data
# Verify README.md and structure exist
```

## Maintenance & Data Retention

### Pruning Old Data

Since the status-data branch is isolated, you can safely truncate its history:

```bash
git checkout status-data

# Create orphan branch from current HEAD
git checkout --orphan status-data-new
git commit -m "Pruned history - keeping only latest data"

# Replace old branch
git branch -D status-data
git branch -m status-data
git push origin status-data --force
```

### Backup Strategy

Since status data is in its own branch, backing up is simple:

```bash
# Clone only status-data branch
git clone --single-branch --branch status-data \
  https://github.com/YOUR-ORG/YOUR-REPO.git status-backup

# Or export to archive
git archive --format=tar.gz --output=status-data-backup.tar.gz status-data
```

## Troubleshooting

### Issue: "Branch status-data does not exist"

**Solution**: Run the setup script:
```bash
npx stentorosaur-setup-status-branch
```

### Issue: "You have uncommitted changes"

**Solution**: Commit or stash your changes before running migration:
```bash
git stash
npx stentorosaur-migrate-to-status-branch
git stash pop
```

### Issue: "Failed to push to remote"

**Solution**: The branch may not be pushed yet:
```bash
git checkout status-data
git push -u origin status-data
```

### Issue: Build fails to find status-data

**Solution**: Ensure your build workflow checks out both branches:
```yaml
- uses: actions/checkout@v4
  with:
    ref: main
    path: main
- uses: actions/checkout@v4
  with:
    ref: status-data
    path: status-data
```

## Migration Checklist

- [ ] Backup your repository before starting
- [ ] Run `npx stentorosaur-setup-status-branch` to create orphaned branch
- [ ] Run `npx stentorosaur-migrate-to-status-branch` to move existing data
- [ ] Update `.github/workflows/monitor-systems.yml` to use orphaned branch pattern
- [ ] Update deployment workflow to checkout both branches
- [ ] Test workflows manually with `workflow_dispatch`
- [ ] Verify status page displays correctly after deployment
- [ ] Optional: Remove `status-data/` from main branch (done automatically by migration script)

## Comparison: Main Branch vs Orphaned Branch

| Aspect | Main Branch | Orphaned Branch | Winner |
|--------|-------------|-----------------|--------|
| Repo size | Grows indefinitely | Isolated growth | ‚úÖ Orphaned |
| Clone speed | Slows over time | Main stays fast | ‚úÖ Orphaned |
| History clarity | Polluted with status commits | Clean code history | ‚úÖ Orphaned |
| Setup complexity | Simple | Requires initial setup | ‚öñÔ∏è Main |
| CI/CD isolation | May trigger unnecessarily | Separate triggers | ‚úÖ Orphaned |
| Data retention | Hard to prune | Easy to truncate | ‚úÖ Orphaned |
| Industry standard | Not common | Used by Upptime | ‚úÖ Orphaned |

## Additional Resources

- [Upptime Documentation](https://upptime.js.org/)
- [Git Orphan Branches](https://git-scm.com/docs/git-checkout#Documentation/git-checkout.txt---orphanltnewbranchgt)
- [GitHub Actions Best Practices](https://docs.github.com/en/actions/learn-github-actions/best-practices-for-github-actions)
- [Plugin Documentation](./README.md)

## Support

If you encounter issues:

1. Check this guide's troubleshooting section
2. Review workflow logs in GitHub Actions
3. Open an issue at: https://github.com/amiable-dev/docusaurus-plugin-stentorosaur/issues
